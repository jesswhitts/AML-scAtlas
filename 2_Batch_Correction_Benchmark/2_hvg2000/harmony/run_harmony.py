#!/usr/bin/env python
# coding: utf-8

#################################################################################################################################
################################################## AML ATLAS BATCH CORRECTION ###################################################
################################################# Batch Correction with Harmony #################################################
#################################################################################################################################


import os
import numpy as np
import pandas as pd
import scanpy as sc
import anndata as ad
import matplotlib
import scib

# create output directories
if not os.path.exists("outs"):
    os.makedirs("outs")

adata = sc.read_h5ad("../outs/filtered_atlasData_uncorrected.h5ad")


#################################################################################################################################
####################################### Run Harmony using the scIB Python Implementation ########################################
#################################################################################################################################

scib.ig.harmony(adata, batch="sample")


#################################################################################################################################
################################################## Visualise Harmony Results ####################################################
#################################################################################################################################

sc.pp.neighbors(adata, n_pcs =30, use_rep = "X_emb")
sc.tl.umap(adata)

sc.pl.umap(adata, color="sample", save="_harmony_sample.png", palette=list(matplotlib.colors.CSS4_COLORS.values()))
sc.pl.umap(adata, color="study", save="_harmony_study.png")


#################################################################################################################################
###################################################### Harmony Complete! ########################################################
#################################################################################################################################

emb = ad.AnnData(adata.obsm["X_emb"])
emb.write_h5ad("outs/harmony_embedding.h5ad")

